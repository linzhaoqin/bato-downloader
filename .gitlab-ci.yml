# GitLab CI/CD Configuration for Universal Manga Downloader
# Documentation: https://docs.gitlab.com/ee/ci/

stages:
  - lint
  - test
  - build

default:
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -e .

# Lint job - Check code quality with Ruff
"lint:ruff":
  stage: lint
  script:
    - pip install ruff
    - echo "Running Ruff linter..."
    - ruff check .
  allow_failure: false

# Type checking job with MyPy
"lint:mypy":
  stage: lint
  script:
    - pip install mypy
    - echo "Running MyPy type checker..."
    - mypy manga_downloader.py config.py umd_cli.py core/ plugins/ services/ ui/ utils/ --no-error-summary || true
  allow_failure: true

# Test job - Run pytest
"test:pytest":
  stage: test
  script:
    - pip install pytest
    - echo "Running tests..."
    - pytest tests/ -v --tb=short
  allow_failure: false

# Build job - Create distribution package
"build:package":
  stage: build
  script:
    - pip install build
    - echo "Building package..."
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG

# Build job for tagged releases only
"build:release":
  stage: build
  script:
    - pip install build
    - echo "Creating release build..."
    - python -m build
  artifacts:
    paths:
      - dist/
    name: "universal-manga-downloader-$CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
