# GitLab CI/CD Configuration for Universal Manga Downloader
# Documentation: https://docs.gitlab.com/ee/ci/

stages:
  - lint
  - security
  - test
  - performance
  - build

variables:
  PYTHON_VERSION: "3.11"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

default:
  image: python:${PYTHON_VERSION}
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -e .

"lint:ruff":
  stage: lint
  script:
    - pip install ruff
    - ruff check .
  allow_failure: false

"lint:mypy":
  stage: lint
  script:
    - pip install mypy
    - mypy manga_downloader.py config.py umd_cli.py core/ plugins/ services/ ui/ utils/ --no-error-summary
  allow_failure: false

"security:pip-audit":
  stage: security
  script:
    - pip install pip-audit
    - pip-audit -r requirements.txt
  allow_failure: false

"test:coverage":
  stage: test
  script:
    - pip install pytest coverage
    - coverage run -m pytest tests/ -v --tb=short -m "not performance"
    - coverage xml
    - coverage report
  artifacts:
    when: always
    paths:
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  coverage: '/TOTAL\s+\d+\s+\d+\s+\d+\s+(\d+%)/'
  needs:
    - "lint:ruff"
    - "lint:mypy"
    - "security:pip-audit"

"performance:pytest":
  stage: performance
  script:
    - pip install pytest
    - pytest tests/performance -m performance -q --disable-warnings
  needs:
    - "lint:ruff"
    - "lint:mypy"

"build:package":
  stage: build
  script:
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  needs:
    - "test:coverage"
    - "performance:pytest"

"build:release":
  stage: build
  script:
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    name: "universal-manga-downloader-$CI_COMMIT_TAG"
  rules:
    - if: $CI_COMMIT_TAG
