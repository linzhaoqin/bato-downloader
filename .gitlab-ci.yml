# GitLab CI/CD Configuration for Universal Manga Downloader
# Documentation: https://docs.gitlab.com/ee/ci/

# Define stages (pipeline phases)
stages:
  - lint
  - test
  - build

# Default settings for all jobs
default:
  image: python:3.11
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -e .
    - pip install ruff mypy pytest

# Lint job - Check code quality
lint:ruff:
  stage: lint
  script:
    - echo "Running Ruff linter..."
    - ruff check .
  allow_failure: false

# Type checking job
lint:mypy:
  stage: lint
  script:
    - echo "Running MyPy type checker..."
    - mypy manga_downloader.py config.py umd_cli.py core/ parsers/ plugins/ services/ utils/ --no-error-summary || true
  allow_failure: true  # Type checking can be strict

# Test job - Run pytest
test:pytest:
  stage: test
  script:
    - echo "Running tests..."
    - pytest tests/ -v --tb=short
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      junit: report.xml
    expire_in: 1 week
  allow_failure: false

# Build job - Create distribution
build:package:
  stage: build
  script:
    - echo "Building package..."
    - pip install build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 month
  only:
    - main
    - tags

# Optional: Build job for releases only
build:release:
  stage: build
  script:
    - echo "Creating release build..."
    - pip install build
    - python -m build
    - echo "Build complete for version $(python -c 'import tomllib; print(tomllib.load(open(\"pyproject.toml\", \"rb\"))[\"project\"][\"version\"])')"
  artifacts:
    paths:
      - dist/
    name: "universal-manga-downloader-$CI_COMMIT_TAG"
  only:
    - tags
  except:
    - branches
